[Reproduction Status Summary â€” Unsupervised Anomaly Detection Improves]

Goal:
Implement the paperâ€™s unsupervised anomaly detection pipeline for filtering abnormal images (raindrop) from a mixed driving dataset (16000 clean + 1600 dirty), using a convolutional autoencoder (CAE) with latent reference loss, then export filtering results to an .npz file.

What has been implemented (aligned with the paper):
1) Dataset:
- Built a mixed dataset: 16000 clean + 1600 raindrop images.
- Images resized to 224x224, converted to float in [0,1], NCHW format.
- For visualization/debug, dirty samples are placed at the end of the dataset (index >= 16000).

2) Model:
- Implemented a CAE with latent_dim=256.
- Forward: x -> encoder -> z; decoder(z) -> x_rec.

3) Training (100 epochs):
- Loss: L = L_rec + Î» * L_ref, where:
  - L_rec: pixel-level MSE between x and x_rec.
  - L_ref: latent reference loss based on nearest neighbor in a reference latent set H_ref.
- Each epoch rebuilds H_ref by randomly sampling M_ref=1024 points and encoding them.
- Optimizer: Adam, lr=5e-4; Î»=1.0; batch size followed the notebook setup.

4) Scoring + Filtering:
- Computed reconstruction PCC for each sample, then applied a 1D median filter (k=101) to obtain PCC_med.
- Used the paperâ€™s threshold rule: Î´ = median(PCC_med) - 0.05; classify as dirty if PCC_med < Î´.
- Exported results into an NPZ file (keys include: pcc, pcc_med, delta, is_clean).

Key debug observations (current issue):
1) PCC_med behavior is opposite to the paperâ€™s expectation:
- PCC_med shows an upward jump when entering the dirty segment (after index ~16000), rather than a drop.
- This leads to poor separability between clean and dirty using â€œlower PCC => anomalyâ€.

2) Threshold Î´ becomes too low, causing all samples to be kept:
- Example: median(PCC_med) â‰ˆ 0.977 -> Î´ â‰ˆ 0.927.
- PCC_med values stay around ~0.97â€“0.986, so PCC_med is always > Î´.
- Result: kept ratio = 1.0; dirty kept ratio = 1.0 (no filtering).

3) MSE does not separate clean vs dirty either (even reversed trend):
- Observed median MSE(clean) > median MSE(dirty), i.e., dirty reconstruction error is not larger.

4) Visual inspection:
- Orig vs recon pairs show raindrop-like residuals in |orig - recon|*5 maps, meaning anomalies exist visually,
  but current scalar metrics (PCC/MSE) are not producing a clean/dirty separation.

Conclusion:
- The full training + scoring pipeline runs successfully and NPZ export is working.
- However, the anomaly score direction/separability is not reproduced yet (dirty is not pushed to lower PCC/higher error),
  so filtering with the paperâ€™s threshold rule fails (keeps all data).


1) è®ºæ–‡çš„ PCC æ£€æµ‹è§„åˆ™åœ¨æˆ‘è¿™è¾¹ä¸è§¦å‘

æŒ‰è®ºæ–‡æµç¨‹ç®—äº† PCC(x, xrec)ï¼Œå†åš median filter å¾—åˆ° PCC_medï¼Œé˜ˆå€¼ç”¨

ğ›¿=median(ğ‘ƒğ¶ğ¶_ğ‘šğ‘’ğ‘‘)âˆ’0.05
Î´=median(PCC_med)âˆ’0.05ï¼ˆè®ºæ–‡çš„è®¾ç½®ï¼‰ã€‚

Unsupervised Anomaly Detection â€¦

ç»“æœï¼šdelta â‰ˆ 0.9271ï¼Œä½† PCC_med å…¨ç¨‹å¤§çº¦åœ¨ 0.975~0.986ï¼Œå› æ­¤ is_clean å…¨ Trueï¼Œ17600/17600 å…¨ä¿ç•™ã€‚

2) æ›´â€œåç›´è§‰â€çš„ç°è±¡ï¼šdirty æ®µæŒ‡æ ‡åè€Œæ›´å¥½

ä» PCC_med vs index å›¾çœ‹ï¼šåœ¨ index=16000ï¼ˆclean/dirty åˆ†ç•Œï¼‰åï¼Œæ›²çº¿ æ•´ä½“ä¸Šè·³ï¼ˆdirty æ®µ PCC_med æ›´é«˜ï¼‰ã€‚

ä» MSE(x, xrec) vs index å›¾çœ‹ï¼šdirty æ®µ æ•´ä½“æ›´ä½ï¼ˆé‡å»ºè¯¯å·®æ›´å°ï¼‰ã€‚

3) åˆ†å¸ƒç»Ÿè®¡è¯æ®ï¼ˆéå¸¸å…³é”®ï¼‰

ä½ ç”»çš„ç›´æ–¹å›¾ + median ç›´æ¥è¯´æ˜ä¸¤ç±»æ˜¯â€œåˆ†å¼€ä¸”æ–¹å‘ç›¸åâ€ï¼š

PCC medianï¼šclean 0.9770 < dirty 0.9847

MSE medianï¼šclean 0.001022 > dirty 0.000713
â‡’ æ¨¡å‹å¯¹ dirtyï¼ˆraindropï¼‰æ›´å®¹æ˜“é‡å»ºï¼Œæ‰€ä»¥ â€œä½ PCC / é«˜è¯¯å·® = å¼‚å¸¸â€ çš„å‡è®¾ä¸æˆç«‹ã€‚

4) è§†è§‰è¯æ®ï¼ˆå®šæ€§ï¼‰

éšæœºæŠ½å– dirty çš„â€œåŸå›¾ vs é‡å»ºâ€èƒ½çœ‹åˆ° raindrop/é›¾çŠ¶åŒºåŸŸï¼›

residualï¼ˆâˆ£ğ‘¥âˆ’ğ‘¥ğ‘Ÿğ‘’ğ‘âˆ£âˆ£xâˆ’xrecâˆ£ï¼‰å›¾ä¸­è¯¥åŒºåŸŸç¡®å®æ›´äº®ï¼Œè¯´æ˜å±€éƒ¨å·®å¼‚å­˜åœ¨ï¼›

ä½†å…¨å±€ PCC ä¾ç„¶å¾ˆé«˜ï¼Œè¯´æ˜ å±€éƒ¨å¼‚å¸¸æ²¡æœ‰æ˜¾è‘—æ‹‰ä½å…¨å±€ç›¸å…³ç³»æ•°ã€‚

5) å½“å‰é˜¶æ®µç»“è®º

ç›®å‰çš„å¤ç°ç»“æœè¡¨æ˜ï¼šåœ¨ä½ è¿™å¥—æ•°æ®/æ¨¡å‹è®¾ç½®ä¸‹ï¼Œraindrop å¹¶æ²¡æœ‰è¡¨ç°ä¸ºâ€œæ›´éš¾é‡å»ºçš„å¼‚å¸¸â€ï¼Œåè€Œæ›´åƒä¸€ç§â€œæ›´å¹³æ»‘ã€æ˜“é‡å»ºâ€çš„æ¨¡å¼ï¼Œå› æ­¤è®ºæ–‡çš„ PCC é˜ˆå€¼è¿‡æ»¤æ­¥éª¤ä¸ä¼šç­›æ‰ dirtyã€‚

6) å·²å®Œæˆäº§å‡º

å·²ç”Ÿæˆå¹¶ä¿å­˜ filter_result_raindrop.npzï¼ˆåŒ…å« pcc, pcc_med, mse, delta, is_cleanï¼‰ï¼Œåç»­æ— éœ€é‡å¤è®¡ç®—ã€‚

ç°åœ¨çš„æƒ…å†µï¼šä»£ç è·‘é€šäº†ï¼Œä½†â€œæŒ‰è®ºæ–‡çš„åˆ¤åˆ«é€»è¾‘è¿‡æ»¤ dirtyâ€çš„æ•ˆæœè¿˜æ²¡å¤ç°å‡ºæ¥â€”â€”æ‰€ä»¥ä¸æ˜¯â€œå¤±è´¥=è·‘ä¸èµ·æ¥â€ï¼Œè€Œæ˜¯**â€œç»“æœå’Œè®ºæ–‡é¢„æœŸç›¸å/ä¸åˆ†ç¦»â€**ã€‚

è®ºæ–‡çš„æ ¸å¿ƒé¢„æœŸæ˜¯ï¼šåŠ äº† latent reference loss åï¼Œdirty çš„é‡å»ºä¼šæ›´å·® â†’ PCC æ›´ä½ï¼ˆæˆ–è¯¯å·®æ›´é«˜ï¼‰ï¼Œç„¶åç”¨ median filter + é˜ˆå€¼æŠŠå®ƒä»¬ç­›æ‰ã€‚è®ºæ–‡æ˜ç¡®å†™äº†ç”¨ PCC + ä¸­å€¼æ»¤æ³¢ï¼Œå¹¶ç”¨ Î´ = median(PCC_med) - 0.05 åšé˜ˆå€¼ã€‚

Unsupervised Anomaly Detection â€¦






1) ä½ ç›®å‰è·‘å‡ºæ¥çš„ç°è±¡ï¼ˆdebug ç»“è®ºï¼‰

ä»ä½ æˆªå›¾é‡Œèƒ½è¯»åˆ°å‡ ä¸ªå…³é”®äº‹å®ï¼š

PCC_med åœ¨ dirty æ®µåè€Œâ€œæ›´é«˜â€
ä½ çš„ PCC_med æ›²çº¿åœ¨ indexâ‰ˆ16000ï¼ˆdirty å¼€å§‹ï¼‰å‡ºç°æ˜æ˜¾ä¸Šè·³ï¼Œè€Œä¸æ˜¯è®ºæ–‡å›¾é‡Œé‚£ç§â€œæ‰ä¸‹å»â€ã€‚
æ‰€ä»¥å¦‚æœä½ ç”¨è®ºæ–‡é˜ˆå€¼é€»è¾‘ï¼ˆPCC_med < Î´ â†’ dirtyï¼‰ï¼Œå°±ä¼šå‡ºç°ï¼šdirty å…¨éƒ¨åœ¨é˜ˆå€¼ä¹‹ä¸Š â†’ ä¸€ä¸ªéƒ½ç­›ä¸æ‰ã€‚

é˜ˆå€¼ Î´ è¢«ç®—å¾—å¤ªä½ï¼Œå¯¼è‡´å¿…ç„¶å…¨ä¿ç•™
ä½ ç®—å‡ºæ¥ median(PCC_med)â‰ˆ0.977ï¼Œæ‰€ä»¥ Î´â‰ˆ0.927ï¼ˆ0.977-0.05ï¼‰ã€‚
ä½†ä½ çš„ PCC_med å…¨ç¨‹éƒ½åœ¨ ~0.97~0.986 ä¹‹é—´æ³¢åŠ¨ï¼Œå½“ç„¶ å…¨éƒ¨ > 0.927ï¼Œæ‰€ä»¥ kept ratio=1.0 æ˜¯å¿…ç„¶ç»“æœã€‚

MSE ä¹Ÿæ²¡æœ‰æŒ‰é¢„æœŸæ‹‰å¼€ï¼Œç”šè‡³ dirty çš„ MSE ä¸­ä½æ•°æ›´å°
ä½ æ‰“å°äº† MSE median clean/dirty: 0.00102 vs 0.000713ï¼ˆdirty æ›´ä½ï¼‰ï¼Œè¿™å’Œâ€œdirty é‡å»ºæ›´å·®â€çš„ç›´è§‰/è®ºæ–‡ç»“è®ºç›¸åã€‚

å¯è§†åŒ–ç¡®å®èƒ½çœ‹åˆ° raindrop çš„æ®‹ç•™/å·®å¼‚å›¾
ä½ è´´çš„ |orig-recon|*5 å·®å¼‚å›¾é‡Œèƒ½çœ‹åˆ°ç±»ä¼¼ raindrop/çº¹ç†æ®‹å·®ï¼Œè¯´æ˜ï¼š

æ¨¡å‹ä¸æ˜¯å®Œå…¨å­¦ä¼šæŠŠå¼‚å¸¸â€œæŠ¹å¹³â€ï¼Œ

ä½†ä½ ç”¨çš„ PCC/MSE æŒ‡æ ‡åœ¨å…¨å±€ç»Ÿè®¡ä¸Šå¹¶æ²¡æœ‰æŠŠ dirty æ¨åˆ°æ›´â€œå·®â€çš„åˆ†å¸ƒã€‚

2) æ‰€ä»¥æˆ‘ä»¬æ˜¯â€œå¤±è´¥äº†å—â€ï¼Ÿ

ç»“è®ºï¼šè¿˜æ²¡å¤ç°è®ºæ–‡â€œå¯åˆ†ç¦»çš„ anomaly scoreâ€ï¼Œä½† pipeline å·²ç»è·‘é€šã€‚

ä½ å·²ç»å®Œæˆäº†è®ºæ–‡æµç¨‹é‡Œæœ€å…³é”®çš„å·¥ç¨‹éƒ¨åˆ†ï¼š

MixDatasetï¼ˆ16000 clean + 1600 raindropï¼Œ224Ã—224ï¼Œå½’ä¸€åŒ–åˆ°[0,1]ï¼‰

CAEï¼ˆlatent_dim=256ï¼‰

è®­ç»ƒï¼šL = Lrec + Î» Lrefï¼Œæ¯ epoch é‡å»º H_ref

æ¨ç†ï¼šç®— PCCã€median filterï¼ˆk=101ï¼‰ã€é˜ˆå€¼ Î´ã€å¯¼å‡º npz
è¿™äº›éƒ½å¯¹é½è®ºæ–‡æè¿°ã€‚

Unsupervised Anomaly Detection â€¦

ä½†ç›®å‰**â€œåˆ¤åˆ«ä¿¡å·æ–¹å‘ä¸å¯¹/åˆ†å¸ƒä¸åˆ†ç¦»â€**ï¼Œå¯¼è‡´è¿‡æ»¤å¤±è´¥ï¼ˆå…¨ä¿ç•™ï¼‰ã€‚